name: Deploy to minikube using GitHub Actions

on: [push]

jobs:
  job1:
    runs-on: ubuntu-22.04
    name: build Node.js Docker Image and deploy to minikube

    env:
      IMAGE_TAG: ${{ github.sha }}

    steps:
    - uses: actions/checkout@v4

    - name: Start minikube
      uses: medyagh/setup-minikube@v0.0.20

    - name: Verify cluster
      run: kubectl get pods -A

    - name: Build Docker image
      run: |
        eval $(minikube -p minikube docker-env)
        echo "Building image devopshint/node-app:${IMAGE_TAG}"
        echo "Updating image tag in k8s manifest..."
        sed -i "/name: nodejs-app/{n;s|image: .*|image: devopshint/node-app:${IMAGE_TAG}|;}" k8s-node-app.yaml
        echo "Let_s see image name:"
        grep "image:" k8s-node-app.yaml

    - name: Deploy to minikube
      run: kubectl apply -f k8s-node-app.yaml

    - name: Wait for deployment readiness
      run: |
        echo "Waiting for nodejs-app deployment"
        kubectl rollout status deployment/nodejs-app --timeout=180s
        echo "nodejs-app deployment is ok!"

    - name: Debug if not ready
      if: failure()
      run: |
        echo "==== Debugging nodejs-app pod (not ready) ===="
        echo ""
        echo "---- pod list ----"
        kubectl get pods -l app=nodejs-app -o wide || true
        echo ""
        echo "---- pod describe ----"
        kubectl describe pod -l app=nodejs-app || true
        echo ""
        echo "---- pod logs ----"
        kubectl logs -l app=nodejs-app --all-containers --tail=50 || true
        echo ""
        echo "==== End of debug info ===="

    - name: Health check
      run: |
        echo "Retrieving pod name"
        POD_NAME=$(kubectl get pod -l app=nodejs-app -o jsonpath='{.items[0].metadata.name}')
        echo "Found pod: $POD_NAME"

        echo "Starting port-forward from localhost:8080 â†’ pod/$POD_NAME:3000 ..."
        kubectl port-forward pod/$POD_NAME 8080:3000 &
        PF_PID=$!

        echo "Waiting for response on localhost"
        SECONDS=0
        until curl -fs http://127.0.0.1:8080 > /dev/null; do
          if [ $SECONDS -ge 150 ]; then
            echo "App did not respond after 150 seconds."
            kill $PF_PID
            exit 1
          fi
          echo "App not ready yet... waited ${SECONDS}s"
          sleep 5
        done

        echo "App is healthy and responding!"
        kill $PF_PID
