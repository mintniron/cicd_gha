name: Deploy to Minikube using GitHub Actions

on: [push]
  
jobs:
  job1:
    runs-on: ubuntu-22.04
    name: build Node.js Docker Image and deploy to minikube
    steps:
    - uses: actions/checkout@v4
    - name: Start minikube
      uses: medyagh/setup-minikube@v0.0.20
    - name: Try the cluster !
      run: kubectl get pods -A
    - name: Build image
      run: |
        eval $(minikube -p minikube docker-env)
        IMAGE_TAG=${{ github.sha }}
        docker build -t devopshint/node-app:${IMAGE_TAG} .
        sed -i "s|image: devopshint/node-app:.*|image: devopshint/node-app:${IMAGE_TAG}|" k8s-node-app.yaml

    - name: Deploy to minikube
      run: |
        kubectl apply -f k8s-node-app.yaml
    - name: Wait for Pod Readiness
      run: |
          echo "Waiting for nodejs-app Pod to be ready..."
          # Let's wait up to 5 minutes for app=nodejs-app pod to be ready
          kubectl wait --for=condition=ready pod -l app=nodejs-app --timeout=300s
          echo "nodejs-app Pod is now ready!"

    - name: Let_s debug
      run: |
        echo "Seeing pod and service extended indo"
        kubectl get pods -o wide
        kubectl describe svc nodejs-app
        kubectl describe pod -l app=nodejs-app
        echo "Endpoints:"
        kubectl get endpoints nodejs-app

   
    - name: Health Check
      run: |
        URL=$(minikube service nodejs-app --url)
        for i in {1..30}; do
          if curl -fs "$URL" > /dev/null; then
            echo "App's healthy"
            exit 0
          fi
          echo "Waiting for app... ($i/30)"
          sleep 5
        done
        echo "App did not respond"
        exit 1
